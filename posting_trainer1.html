<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä»•è¨³â†’è»¢è¨˜ ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ v2</title>
  <style>
    :root{--ink:#1f2937; --muted:#6b7280; --line:#e5e7eb; --ok:#e7f8e7; --warn:#fff8e7; --ng:#fdeaea}
    *{box-sizing:border-box}
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", Meiryo, sans-serif; margin:0; background:#fafafa; color:var(--ink)}
    main{max-width:980px; margin:0 auto; padding:20px 16px 40px}
    .card{background:#fff; border:1px solid var(--line); border-radius:14px; padding:14px 16px; box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .muted{color:var(--muted)}
    #problemLine{color:#111; font-weight:700}
    select,input,button,textarea{border-radius:10px; border:1px solid var(--line); padding:8px 10px; font-size:14px; background:#fff}
    button.primary{background:#111; color:#fff; border-color:#111}

    /* Tå­—å‹˜å®š */
    .taccount{position:relative; margin:26px 4px; background:#fff; border-radius:8px; padding:0 8px 10px}
    .taccount .title{font-weight:700; text-align:center; margin:0 0 6px}
    .taccount .hline{border-top:1px solid #333; height:0; margin:0 8px}
    .taccount .pane{position:relative; padding:10px 8px 0 8px}
    .taccount .pane::before{content:""; position:absolute; top:0; bottom:0; left:50%; transform:translateX(-0.5px); width:1px; background:#333}
    .cols{display:grid; grid-template-columns:1fr 1fr; gap:16px; align-items:start}

    /* å…¥åŠ›è¡Œï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼‰ */
    .entry{display:grid; grid-template-columns: minmax(7rem,1fr) minmax(72px,12ch); gap:8px; margin:0}
    .entry input{height:40px; width:100%; min-width:0}
    .money{text-align:right}

    /* å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã®ãƒ”ãƒ«è¡¨ç¤º */
    .pill{background:#f8fafc; border:1px solid var(--line); border-radius:12px; padding:6px 10px; display:flex; justify-content:space-between; gap:16px; align-items:center; height:40px}
    .pill .note{color:#374151}
    .pill .amt{min-width:88px; text-align:right; font-variant-numeric:tabular-nums}

    .ok{background:var(--ok)} .warn{background:var(--warn)} .ng{background:var(--ng)}
    .feedback table{width:100%; border-collapse:collapse}
    .feedback th, .feedback td{border:1px solid var(--line); padding:6px}
    .feedback th{background:#f8fafc; text-align:left}

    /* ä»•è¨³è¡¨ */
    .journal{margin:6px 0 12px}
    .journal h4{margin:0 0 8px 0}
    .journal table{width:100%; border-collapse:collapse; table-layout:fixed}
    .journal th,.journal td{border:1px solid var(--line); padding:6px; vertical-align:middle}
    .journal th{background:#f8fafc}
    .journal td.right{text-align:right; font-variant-numeric:tabular-nums}
    .journal .double{border-left:3px double #999 !important;}
    .journal input{width:100%; min-width:0}

    /* ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå‡ºåŠ› */
    #aiPrompt{width:100%; min-height:180px}
    .btn-row{display:flex; gap:8px; flex-wrap:wrap}

    @media (max-width:640px){
      .entry{grid-template-columns: minmax(6rem,1fr) minmax(68px,10ch)}
      .pill .amt{min-width:68px}
      .cols{gap:12px}
    }
  </style>
</head>
<body>
  <main>
    <section class="card" style="margin-bottom:12px">
      <div class="row">
        <div>å•é¡Œé¸æŠï¼š</div>
        <select id="problemSelect"></select>
        <button id="btnPrev">å‰</button>
        <button id="btnNext">æ¬¡</button>
        <button id="btnLoadCsv">TSVã‚’èª­ã¿è¾¼ã‚€</button>
        <button id="btnTpl">TSVã²ãªå½¢</button>
      </div>
      <div id="problemLine" style="margin-top:8px"></div>
      <input id="csvFile" type="file" accept=".tsv,.csv" style="display:none" />
      <div class="row" style="margin-top:8px">
        <button id="btnLearn">å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ­£ã—ã„ä»•è¨³ã¨è»¢è¨˜ã‚’è¦‹ã‚‹ï¼‰</button>
        <button id="btnHide">è§£èª¬ã‚’é–‰ã˜ã‚‹</button>
        <button id="btnReset">æ¼”ç¿’ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="btnGrade" class="primary">æ¡ç‚¹</button>
        <div id="scoreAll" style="font-weight:700"></div>
      </div>
      <div class="muted" style="margin-top:6px">â€» å…¥åŠ›ã¯ <strong>ç›¸æ‰‹ç§‘ç›®</strong> ã¨ <strong>é‡‘é¡</strong>ï¼ˆè»¢è¨˜æ¬„ï¼‰ã€‚è¤‡åˆä»•è¨³ã®æ‘˜è¦ã¯ã€Œè«¸å£ã€ã€‚åŒä¸€ãƒ•ã‚©ãƒ«ãƒ€ã« <code>problems_unified.tsv</code>ï¼ˆUTF-8+BOM, ã‚¿ãƒ–åŒºåˆ‡ã‚Šï¼‰ãŒã‚ã‚Œã°è‡ªå‹•èª­è¾¼ã—ã¾ã™ã€‚å½¢å¼ã¯ <code>id\tp\tp\tå•é¡Œæ–‡</code> ã¨ <code>id\té †ç•ª\t(d/c/å€Ÿ/è²¸)\tç§‘ç›®\té‡‘é¡</code>ã€‚</div>
    </section>

    <section class="card" style="margin-bottom:12px">
      <h3 style="margin:0 0 8px 0">â‘  ä»•è¨³ã®è¨˜å…¥</h3>
      <div id="journalPanel" class="journal"></div>
      <div id="journalFeedback" class="feedback" style="margin-top:8px"></div>
    </section>

    <section class="card" style="margin-bottom:12px">
      <h3 style="margin:0 0 8px 0">â‘¡ å‹˜å®šåˆ¥ Tå‹˜å®šï¼ˆå·¦å³æ¬„ã«è¨˜å…¥ï¼‰</h3>
      <div id="ledger"></div>
      <div id="learnPanel" style="margin-top:8px"></div>
      <div id="ledgerFeedback" class="feedback" style="margin-top:8px"></div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px 0">â‘¢ AI è§£èª¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h3>
      <div class="btn-row" style="margin-bottom:8px">
        <button id="btnMakePrompt">æ¡ç‚¹çµæœã‹ã‚‰ç”Ÿæˆ</button>
        <button id="btnCopyPrompt">ã‚³ãƒ”ãƒ¼</button>
      </div>
      <textarea id="aiPrompt" placeholder="æ¡ç‚¹å¾Œã«ï¼»æ¡ç‚¹çµæœã‹ã‚‰ç”Ÿæˆï¼½ã‚’æŠ¼ã™ã¨ã“ã“ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå…¥ã‚Šã¾ã™"></textarea>
    </section>
  </main>

<script>
/********** æ—¢å®šãƒ‡ãƒ¼ã‚¿ï¼ˆçµ±åˆTSVãŒç„¡ã„ã¨ãã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ **********/
const DEFAULT_PROBLEMS = [
  { id:"J2-0001", text:"ä»•å…¥1,000å††ã‚’å½“åº§é é‡‘300å††æ”¯æ‰•ã„ã€æ®‹ã‚Šã¯è²·æ›é‡‘ã¨ã—ãŸã€‚",
    lines:[{side:'D',acc:'ä»•å…¥',amt:1000},{side:'C',acc:'å½“åº§é é‡‘',amt:300},{side:'C',acc:'è²·æ›é‡‘',amt:700}] },
  { id:"J2-0002", text:"å£²æ›é‡‘500å††ã‚’ç¾é‡‘ã§å›åã—ãŸã€‚",
    lines:[{side:'D',acc:'ç¾é‡‘',amt:500},{side:'C',acc:'å£²æ›é‡‘',amt:500}] },
  { id:"J2-0003", text:"å‚™å“300å††ã‚’ç¾é‡‘100å††ã¨å½“åº§é é‡‘200å††ã§æ”¯æ‰•ã£ãŸã€‚",
    lines:[{side:'D',acc:'å‚™å“',amt:300},{side:'C',acc:'ç¾é‡‘',amt:100},{side:'C',acc:'å½“åº§é é‡‘',amt:200}] },
  { id:"J2-0004", text:"å•†å“ã‚’è²©å£²ã—ã€ä»£é‡‘ã®ã†ã¡ç¾é‡‘300å††ã‚’å—ã‘å–ã‚Šã€æ®‹ã‚Šã¯æ›ã‘ã¨ã—ãŸï¼ˆå£²ä¸Š800å††ï¼‰ã€‚",
    lines:[{side:'D',acc:'ç¾é‡‘',amt:300},{side:'D',acc:'å£²æ›é‡‘',amt:500},{side:'C',acc:'å£²ä¸Š',amt:800}] }
];
let PROBLEMS = [...DEFAULT_PROBLEMS];

/********** DOM refs **********/
let $sel,$line,$ledger,$learn,$ledgerFb,$journalPanel,$journalFb,$scoreAll,$btnLoadCsv,$btnTpl,$csvFile,$aiPrompt;

/********** Utils **********/
function el(tag, attrs={}, html=""){ const n=document.createElement(tag); for(const [k,v] of Object.entries(attrs)) n.setAttribute(k,v); n.innerHTML=html; return n; }
function fmtMoney(n){ return (Number(n)||0).toLocaleString('ja-JP'); }
function attachCommaHandlers(inp){ inp.addEventListener('focus',()=>{ inp.value=inp.value.replace(/,/g,''); }); inp.addEventListener('blur',()=>{ const raw=inp.value.replace(/,/g,''); if(raw===''){inp.value='';return;} const x=Number(raw); if(!isNaN(x)) inp.value=fmtMoney(x); }); }
function normAcc(s){ return (s||'').trim(); }

/********** æ­£ç­”ã®è»¢è¨˜ï¼ˆè«¸å£ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ **********/
function expandToLedgerEntries(p){
  const deb=p.lines.filter(x=>x.side==='D');
  const cre=p.lines.filter(x=>x.side==='C');
  const out=[];
  deb.forEach(d=>{ const note=cre.length>=2?'è«¸å£':cre[0].acc; out.push({acc:d.acc, side:'D', amt:+d.amt, note}); });
  cre.forEach(c=>{ const note=deb.length>=2?'è«¸å£':deb[0].acc; out.push({acc:c.acc, side:'C', amt:+c.amt, note}); });
  return out;
}

/********** ä»•è¨³æ¬„ã®ç”Ÿæˆãƒ»èª­å– **********/
function buildJournal(p){
  const deb=p.lines.filter(x=>x.side==='D');
  const cre=p.lines.filter(x=>x.side==='C');
  const maxRows=Math.max(deb.length, cre.length);
  let rows='';
  for(let i=0;i<maxRows;i++){
    rows+=`<tr>
      <td><input type="text" data-side="D" data-idx="${i}" placeholder="å€Ÿæ–¹ç§‘ç›®"></td>
      <td class="right"><input type="text" class="money" data-side="D" data-idx="${i}" inputmode="numeric" placeholder="é‡‘é¡"></td>
      <td class="double"><input type="text" data-side="C" data-idx="${i}" placeholder="è²¸æ–¹ç§‘ç›®"></td>
      <td class="right"><input type="text" class="money" data-side="C" data-idx="${i}" inputmode="numeric" placeholder="é‡‘é¡"></td>
    </tr>`;
  }
  $journalPanel.innerHTML = `<h4>ä»•è¨³è¡¨ï¼ˆè¡Œæ•°ã¯æ­£ç­”ã«åˆã‚ã›ã¦è‡ªå‹•ï¼‰</h4>
  <table>
    <colgroup>
      <col style="width:35%"><col style="width:15%"><col style="width:35%"><col style="width:15%">
    </colgroup>
    <thead><tr>
      <th>å€Ÿæ–¹ç§‘ç›®</th><th>é‡‘é¡</th>
      <th class='double'>è²¸æ–¹ç§‘ç›®</th><th>é‡‘é¡</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
  $journalPanel.querySelectorAll('input.money').forEach(attachCommaHandlers);
}

function readJournal(){
  const out=[];
  $journalPanel.querySelectorAll('tbody tr').forEach(tr=>{
    const [dAcc,dAmt,cAcc,cAmt]=tr.querySelectorAll('input');
    const dAccVal=dAcc.value.trim(), dAmtVal=dAmt.value.replace(/,/g,'').trim();
    const cAccVal=cAcc.value.trim(), cAmtVal=cAmt.value.replace(/,/g,'').trim();
    if(dAccVal||dAmtVal){ out.push({side:'D',acc:dAccVal,amt:+(dAmtVal||0)}); }
    if(cAccVal||cAmtVal){ out.push({side:'C',acc:cAccVal,amt:+(cAmtVal||0)}); }
  });
  return out;
}

/********** Tå‹˜å®šï¼ˆUIç”Ÿæˆãƒ»èª­å–ï¼‰ **********/
function buildOneAccount(acc){
  const wrap=el('div',{class:'taccount'});
  wrap.dataset.acc=acc;
  wrap.appendChild(el('div',{class:'title'},acc));
  wrap.appendChild(el('div',{class:'hline'}));
  const pane=el('div',{class:'pane'});
  const cols=el('div',{class:'cols'});
  cols.appendChild(makeSide());
  cols.appendChild(makeSide());
  pane.appendChild(cols); wrap.appendChild(pane); return wrap;
}
function makeSide(){
  const side=el('div');
  const row=el('div',{class:'entry'});
  const subj=el('input',{type:'text',placeholder:'ç›¸æ‰‹ç§‘ç›®'});
  const money=el('input',{type:'text',inputmode:'numeric',placeholder:'é‡‘é¡',class:'money'});
  attachCommaHandlers(money);
  row.appendChild(subj); row.appendChild(money); side.appendChild(row); return side;
}
function buildLedger(p){
  const accounts=[...new Set(expandToLedgerEntries(p).map(e=>e.acc))];
  $ledger.innerHTML=''; accounts.forEach(acc=> $ledger.appendChild(buildOneAccount(acc)) );
}
function readStudentLedger(){
  const out=[];
  document.querySelectorAll('.taccount').forEach(accDiv=>{
    const acc=accDiv.dataset.acc; const [L,R]=accDiv.querySelectorAll('.cols > div');
    if(L){ L.querySelectorAll('.entry').forEach(e=>{ const [n,a]=e.querySelectorAll('input'); const raw=(a.value||'').replace(/,/g,''); if(n.value||raw) out.push({acc,side:'D',amt:+(raw||0),note:(n.value||'').trim()}); }); }
    if(R){ R.querySelectorAll('.entry').forEach(e=>{ const [n,a]=e.querySelectorAll('input'); const raw=(a.value||'').replace(/,/g,''); if(n.value||raw) out.push({acc,side:'C',amt:+(raw||0),note:(n.value||'').trim()}); }); }
  });
  return out;
}

/********** æ¡ç‚¹ï¼šä»•è¨³ãƒ»è»¢è¨˜ **********/
function matchJournal(student,correct){
  const used=new Set(); let score=0; const N=correct.length; const details=[];
  const pickNearest=(ce)=>{
    let cand = student.find(se=>se.side===ce.side && normAcc(se.acc)===ce.acc) ||
               student.find(se=>se.side===ce.side) ||
               student.find(se=>normAcc(se.acc)===ce.acc);
    return cand||null;
  };
  correct.forEach((ce,idx)=>{
    const iFull=student.findIndex((se,i)=>!used.has(i)&&se.side===ce.side&&normAcc(se.acc)===ce.acc&&+se.amt===+ce.amt);
    if(iFull>=0){ used.add(iFull); score+=100/N; details.push({idx,type:'å®Œå…¨ä¸€è‡´',expect:ce,got:student[iFull],cls:'ok'}); return; }

    const iSideAmt=student.findIndex((se,i)=>!used.has(i)&&se.side===ce.side&&+se.amt===+ce.amt);
    if(iSideAmt>=0){ used.add(iSideAmt); score+=80/N; details.push({idx,type:'å€Ÿè²¸ãƒ»é‡‘é¡ä¸€è‡´ï¼ˆç§‘ç›®é•ã„ï¼‰',expect:ce,got:student[iSideAmt],cls:'warn'}); return; }

    const iAccAmt=student.findIndex((se,i)=>!used.has(i)&&normAcc(se.acc)===ce.acc&&+se.amt===+ce.amt&&se.side!==ce.side);
    if(iAccAmt>=0){ used.add(iAccAmt); score+=70/N; details.push({idx,type:'ç§‘ç›®ãƒ»é‡‘é¡ä¸€è‡´ï¼ˆå€Ÿè²¸é€†ï¼‰',expect:ce,got:student[iAccAmt],cls:'warn'}); return; }

    const iAmt=student.findIndex((se,i)=>!used.has(i)&&+se.amt===+ce.amt);
    if(iAmt>=0){ used.add(iAmt); score+=60/N; details.push({idx,type:'é‡‘é¡ã®ã¿ä¸€è‡´',expect:ce,got:student[iAmt],cls:'warn'}); return; }

    details.push({idx,type:'èª¤ã‚Š',expect:ce,got:pickNearest(ce),cls:'ng'});
  });
  return {score:Math.round(score),details};
}

function matchLedger(student,correct){
  const used=new Set(); let score=0; const N=correct.length; const details=[];
  const pickNearest=(ce)=>{
    let cand = student.find(se=>se.acc===ce.acc && se.side===ce.side) ||
               student.find(se=>se.acc===ce.acc) ||
               student.find(se=>se.side===ce.side);
    return cand||null;
  };
  correct.forEach((ce,idx)=>{
    let k=student.findIndex((se,i)=>!used.has(i)&&se.acc===ce.acc&&se.side===ce.side&&+se.amt===+ce.amt&&(se.note||'')===(ce.note||''));
    if(k>=0){ used.add(k); score+=100/N; details.push({idx,type:'å®Œå…¨ä¸€è‡´',expect:ce,got:student[k],cls:'ok'}); return; }
    k=student.findIndex((se,i)=>!used.has(i)&&se.acc===ce.acc&&se.side===ce.side&&+se.amt===+ce.amt);
    if(k>=0){ used.add(k); score+=80/N; details.push({idx,type:'å‹˜å®šãƒ»å€Ÿè²¸ãƒ»é‡‘é¡ä¸€è‡´ï¼ˆç›¸æ‰‹ç§‘ç›®é•ã„ï¼‰',expect:ce,got:student[k],cls:'warn'}); return; }
    k=student.findIndex((se,i)=>!used.has(i)&&+se.amt===+ce.amt);
    if(k>=0){ used.add(k); score+=60/N; details.push({idx,type:'é‡‘é¡ã®ã¿ä¸€è‡´',expect:ce,got:student[k],cls:'warn'}); return; }
    details.push({idx,type:'èª¤ã‚Š',expect:ce,got:pickNearest(ce),cls:'ng'});
  });
  return {score:Math.round(score),details};
}

/********** è¡¨ç¤ºï¼šå­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ãƒ»æ¡ç‚¹çµæœ **********/
function renderLearn(problem){
  const correct=expandToLedgerEntries(problem);
  const accounts=[...new Set(correct.map(e=>e.acc))];
  const wrap=document.createElement('div');

  // æ­£ã—ã„ä»•è¨³
  const voucher=document.createElement('div'); voucher.className='journal';
  voucher.appendChild(el('h4',{},'æ­£ã—ã„ä»•è¨³'));
  const deb=problem.lines.filter(x=>x.side==='D');
  const cre=problem.lines.filter(x=>x.side==='C');
  const maxRows=Math.max(deb.length,cre.length);
  let rows='';
  for(let i=0;i<maxRows;i++){
    const dl=deb[i]; const cr=cre[i];
    rows+=`<tr>
      <td>${dl?dl.acc:''}</td><td class="right">${dl?fmtMoney(dl.amt):''}</td>
      <td class="double">${cr?cr.acc:''}</td><td class="right">${cr?fmtMoney(cr.amt):''}</td>
    </tr>`;
  }
  voucher.innerHTML += `<table>
    <thead><tr>
      <th>å€Ÿæ–¹ç§‘ç›®</th><th>é‡‘é¡</th>
      <th class='double'>è²¸æ–¹ç§‘ç›®</th><th>é‡‘é¡</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
  wrap.appendChild(voucher);

  // æ­£ã—ã„è»¢è¨˜
  wrap.appendChild(el('h4',{},'æ­£ã—ã„è»¢è¨˜ï¼ˆç·å‹˜å®šå…ƒå¸³ï¼‰'));
  accounts.forEach(acc=>{
    const ta=document.createElement('div'); ta.className='taccount';
    ta.appendChild(el('div',{class:'title'},acc));
    ta.appendChild(el('div',{class:'hline'},''));
    const pane=el('div',{class:'pane'}); const cols=el('div',{class:'cols'});
    const left=el('div'); const right=el('div');
    correct.filter(e=>e.acc===acc&&e.side==='D').forEach(e=> left.appendChild(el('div',{class:'pill'},`<span class='note'>${e.note}</span><span class='amt'>${fmtMoney(e.amt)}</span>`)) );
    correct.filter(e=>e.acc===acc&&e.side==='C').forEach(e=> right.appendChild(el('div',{class:'pill'},`<span class='note'>${e.note}</span><span class='amt'>${fmtMoney(e.amt)}</span>`)) );
    cols.appendChild(left); cols.appendChild(right); pane.appendChild(cols); ta.appendChild(pane); wrap.appendChild(ta);
  });
  $learn.innerHTML=''; $learn.appendChild(wrap);
}

function renderJournalFeedback(res){
  const rows=res.details.map(d=>{ const e=d.expect; const g=d.got; const side=e.side==='D'?'å€Ÿ':'è²¸';
    const gotTxt=g? `${g.side==='D'?'å€Ÿ':'è²¸'}:${g.acc}/${fmtMoney(g.amt)}` : '-';
    return `<tr class="${d.cls}"><td>æ¡ç‚¹${d.idx+1}</td><td>${d.type}</td><td>${e.acc}</td><td>${side}</td><td style="text-align:right">${fmtMoney(e.amt)}</td><td>${gotTxt}</td></tr>`; }).join('');
  $journalFb.innerHTML=`<h4>ä»•è¨³ã®æ¡ç‚¹çµæœï¼ˆã‚¹ã‚³ã‚¢ï¼š${res.score}ç‚¹ï¼‰</h4><table>
    <thead><tr><th>é …ç›®</th><th>åˆ¤å®š</th><th>æ­£ç­”ç§‘ç›®</th><th>å€Ÿè²¸</th><th style="text-align:right">æ­£ç­”é‡‘é¡</th><th>å­¦ç”Ÿã®å…¥åŠ›</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

function renderLedgerFeedback(res){
  const rows=res.details.map(d=>{ const e=d.expect; const side=e.side==='D'?'å€Ÿ':'è²¸';
    const gotTxt=d.got? `${d.got.side==='D'?'å€Ÿ':'è²¸'}:${d.got.note}/${fmtMoney(d.got.amt)}` : '-';
    return `<tr class="${d.cls}"><td>æ¡ç‚¹${d.idx+1}</td><td>${d.type}</td><td>${e.acc}</td><td>${side}</td><td>${e.note}</td><td style="text-align:right">${fmtMoney(e.amt)}</td><td>${gotTxt}</td></tr>`; }).join('');
  $ledgerFb.innerHTML=`<h4>è»¢è¨˜ã®æ¡ç‚¹çµæœï¼ˆã‚¹ã‚³ã‚¢ï¼š${res.score}ç‚¹ï¼‰</h4><table>
    <thead><tr><th>é …ç›®</th><th>åˆ¤å®š</th><th>å‹˜å®š</th><th>å€Ÿè²¸</th><th>ç›¸æ‰‹ç§‘ç›®</th><th style="text-align:right">æ­£ç­”é‡‘é¡</th><th>å­¦ç”Ÿã®å…¥åŠ›</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

/********** ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ **********/
function decideErrorFocus(jRes,lRes){
  const jOk=jRes.score===100; const lOk=lRes.score===100;
  if(jOk && !lOk) return 'ä»•è¨³ã¯æ­£ã—ã„ãŒã€è»¢è¨˜ã«èª¤ã‚ŠãŒã‚ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã€‚ç›¸æ‰‹ç§‘ç›®ã‚„å€Ÿè²¸ã®å·¦å³ã€é‡‘é¡ã®ä½ç½®ã‚’ç¢ºèªã•ã›ã‚‹ã€‚';
  if(!jOk) return 'ä»•è¨³æ®µéšã«èª¤ã‚ŠãŒã‚ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã€‚ã¾ãšä»•è¨³ã®è€ƒãˆæ–¹ã‚’å¾©ç¿’ã•ã›ã€ãã®å¾Œã«è»¢è¨˜ã¸é€²ã¾ã›ã‚‹ã€‚';
  return 'å…¨ä½“ã¨ã—ã¦æ­£ã—ã„ã€‚ç¢ºèªã®è¦³ç‚¹ã¨å®šç€ã®ãŸã‚ã®è¿½åŠ ç·´ç¿’ã‚’ææ¡ˆã™ã‚‹ã€‚';
}

function summarizeJournalMistakes(details){
  const msgs=[];
  details.forEach(d=>{
    if(d.type==='å€Ÿè²¸ãƒ»é‡‘é¡ä¸€è‡´ï¼ˆç§‘ç›®é•ã„ï¼‰' && d.got){ msgs.push(`ã€Œ${d.expect.acc}ã€ã¨ã™ã¹ãã¨ã“ã‚ã‚’ã€Œ${d.got.acc}ã€ã¨èª¤è¨˜`); }
    if(d.type==='ç§‘ç›®ãƒ»é‡‘é¡ä¸€è‡´ï¼ˆå€Ÿè²¸é€†ï¼‰' && d.got){ msgs.push(`ã€Œ${d.expect.acc}ã€ã®å€Ÿè²¸ãŒé€†ï¼ˆ${d.got.side==='D'?'å€Ÿæ–¹':'è²¸æ–¹'}ã«è¨˜å…¥ï¼‰`); }
    if(d.type==='é‡‘é¡ã®ã¿ä¸€è‡´'){ msgs.push('é‡‘é¡ã¯åˆã£ã¦ã„ã‚‹ãŒç§‘ç›®ã‚„å€Ÿè²¸ãŒç•°ãªã‚‹'); }
    if(d.type==='èª¤ã‚Š' && d.got){ msgs.push(`è¿‘ã„å…¥åŠ›: ${d.got.side==='D'?'å€Ÿ':'è²¸'}:${d.got.acc}/${fmtMoney(d.got.amt)}`); }
    if(d.type==='èª¤ã‚Š' && !d.got){ msgs.push('è©²å½“è¡ŒãŒè¦‹ã¤ã‹ã‚‰ãªã„ï¼ˆç©ºæ¬„ã¾ãŸã¯é‡‘é¡ä¸ä¸€è‡´ï¼‰'); }
  });
  return [...new Set(msgs)].slice(0,6);
}

function summarizeLedgerMistakes(details){
  const msgs=[];
  details.forEach(d=>{
    if(d.type==='å‹˜å®šãƒ»å€Ÿè²¸ãƒ»é‡‘é¡ä¸€è‡´ï¼ˆç›¸æ‰‹ç§‘ç›®é•ã„ï¼‰' && d.got){ msgs.push(`${d.expect.acc}ã®ç›¸æ‰‹ç§‘ç›®ãŒã€Œ${d.expect.note}ã€â†’ã€Œ${d.got.note}ã€`); }
    if(d.type==='é‡‘é¡ã®ã¿ä¸€è‡´'){ msgs.push(`${d.expect.acc}ã®é‡‘é¡ã¯ä¸€è‡´ã™ã‚‹ãŒç›¸æ‰‹ç§‘ç›®ã‚„å€Ÿè²¸ãŒç•°ãªã‚‹`); }
    if(d.type==='èª¤ã‚Š' && d.got){ msgs.push(`è¿‘ã„å…¥åŠ›: ${d.got.side==='D'?'å€Ÿ':'è²¸'}:${d.got.note}/${fmtMoney(d.got.amt)}`); }
    if(d.type==='èª¤ã‚Š' && !d.got){ msgs.push(`${d.expect.acc}ã®è©²å½“ä»•è¨³ãŒè¦‹ã¤ã‹ã‚‰ãªã„ï¼ˆç©ºæ¬„ã¾ãŸã¯é‡‘é¡ä¸ä¸€è‡´ï¼‰`); }
  });
  return [...new Set(msgs)].slice(0,6);
}

function generateAiPrompt(problem,jRes,lRes,studentJ,studentL){
  const jMist=summarizeJournalMistakes(jRes.details);
  const lMist=summarizeLedgerMistakes(lRes.details);
  const focus=decideErrorFocus(jRes,lRes);

  const fmtJL = (arr,mode)=>{
    if(mode==='journal'){
      const D=arr.filter(x=>x.side==='D'); const C=arr.filter(x=>x.side==='C');
      const rows=Math.max(D.length,C.length);
      let t=[]; for(let i=0;i<rows;i++){
        const dl=D[i], cr=C[i];
        t.push(`å€Ÿ:${dl?dl.acc:''} ${dl?fmtMoney(dl.amt):''}ï½œè²¸:${cr?cr.acc:''} ${cr?fmtMoney(cr.amt):''}`);
      }
      return t.join('\n');
    }else{
      return arr.map(e=> `${e.acc}ï¼ˆ${e.side==='D'?'å€Ÿ':'è²¸'}ï¼‰ ç›¸æ‰‹:${e.note||''} é‡‘é¡:${fmtMoney(e.amt)}`).join('\n');
    }
  };

  const correctJ = fmtJL(problem.lines,'journal');
  const correctL = fmtJL(expandToLedgerEntries(problem),'ledger');
  const studentJtxt = fmtJL(studentJ,'journal') || '(æœªå…¥åŠ›)';
  const studentLtxt = fmtJL(studentL,'ledger') || '(æœªå…¥åŠ›)';

  return `ä»¥ä¸‹ã®ç°¿è¨˜ç·´ç¿’ã®æ¡ç‚¹çµæœã‚’ã‚‚ã¨ã«ã€å­¦ç”Ÿã¸ã®è§£èª¬ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n`+
  `ã€å•é¡Œã€‘${problem.text}\n\n`+
  `ã€å­¦ç”Ÿã®ä»•è¨³ã€‘\n${studentJtxt}\n\n`+
  `ã€æ­£ã—ã„ä»•è¨³ã€‘\n${correctJ}\n\n`+
  `ã€ä»•è¨³æ¡ç‚¹çµæœï¼ˆ${jRes.score}ç‚¹ï¼‰ã€‘\n- ${jMist.join('\n- ') || 'ç‰¹è¨˜äº‹é …ãªã—'}\n\n`+
  `ã€å­¦ç”Ÿã®è»¢è¨˜ã€‘\n${studentLtxt}\n\n`+
  `ã€æ­£ã—ã„è»¢è¨˜ã€‘\n${correctL}\n\n`+
  `ã€è»¢è¨˜æ¡ç‚¹çµæœï¼ˆ${lRes.score}ç‚¹ï¼‰ã€‘\n- ${lMist.join('\n- ') || 'ç‰¹è¨˜äº‹é …ãªã—'}\n\n`+
  `ğŸ‘‰ è§£èª¬æ–¹é‡ï¼š${focus}\n`+
  `ğŸ‘‰ æŒ‡ç¤ºï¼š\n`+
  `- ã©ã®ã‚ˆã†ãªå‹˜é•ã„ãŒã‚ã£ãŸã‹ã‚’æ¨æ¸¬ã—ã¦èª¬æ˜ã™ã‚‹\n`+
  `- ä»•è¨³ã®èª¤ã‚ŠãŒè»¢è¨˜ã«ã©ã†å½±éŸ¿ã—ãŸã‹ï¼ä»•è¨³ã¯æ­£ã—ã„ãŒè»¢è¨˜ãŒãªãœèª¤ã£ãŸã‹ã‚’èª¬æ˜ã™ã‚‹\n`+
  `- æ¬¡ã«åŒã˜å•é¡ŒãŒå‡ºãŸã¨ãã«æ­£ã—ãã§ãã‚‹ã‚ˆã†ã€æ‰‹é †ãƒ™ãƒ¼ã‚¹ã§3ã€œ5å€‹ã®å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ä¸ãˆã‚‹`;
}

/********** UIåˆæœŸåŒ– **********/
let idx=0; let lastJournalRes=null, lastLedgerRes=null;
function rebuildSelect(){ $sel.innerHTML=''; PROBLEMS.forEach(p=> $sel.appendChild(el('option',{value:p.id},`${p.id}ï½œ${p.text.slice(0,24)}â€¦`)) ); }
function load(i){ idx=(i+PROBLEMS.length)%PROBLEMS.length; const p=PROBLEMS[idx]; $line.textContent=`å•é¡ŒID: ${p.id}ã€€å–å¼•: ${p.text}`; $learn.innerHTML=''; $journalFb.innerHTML=''; $ledgerFb.innerHTML=''; $scoreAll.textContent=''; $aiPrompt.value=''; buildJournal(p); buildLedger(p); $sel.value=p.id; }

function setupUI(){
  rebuildSelect();
  $sel.addEventListener('change',()=>{ const i=PROBLEMS.findIndex(p=>p.id===$sel.value); if(i>=0) load(i); });
  document.getElementById('btnPrev').onclick=()=>load(idx-1);
  document.getElementById('btnNext').onclick=()=>load(idx+1);
  document.getElementById('btnLearn').onclick=()=>renderLearn(PROBLEMS[idx]);
  document.getElementById('btnHide').onclick=()=>{ $learn.innerHTML=''; };
  document.getElementById('btnReset').onclick=()=>load(idx);
  document.getElementById('btnGrade').onclick=()=>{
    const p=PROBLEMS[idx];
    const jRes = matchJournal(readJournal(), p.lines);
    const lRes = matchLedger(readStudentLedger(), expandToLedgerEntries(p));
    lastJournalRes=jRes; lastLedgerRes=lRes;
    renderJournalFeedback(jRes); renderLedgerFeedback(lRes);
    $scoreAll.textContent=`ç·åˆï¼š ä»•è¨³ ${jRes.score} ç‚¹ ï¼ è»¢è¨˜ ${lRes.score} ç‚¹`;
  };
  document.getElementById('btnMakePrompt').onclick=()=>{
    const p=PROBLEMS[idx];
    const jRes = lastJournalRes || matchJournal(readJournal(), p.lines);
    const lRes = lastLedgerRes || matchLedger(readStudentLedger(), expandToLedgerEntries(p));
    $aiPrompt.value = generateAiPrompt(p, jRes, lRes, readJournal(), readStudentLedger());
  };
  document.getElementById('btnCopyPrompt').onclick=async()=>{
    try{ await navigator.clipboard.writeText($aiPrompt.value||''); alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }catch(e){ alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  };

  // TSV èª­è¾¼ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã€çµ±åˆ1æšï¼‰
  $btnLoadCsv.onclick=()=> $csvFile.click();
  $csvFile.onchange=async(e)=>{ const f=(e.target.files||[])[0]; if(!f) return; const text=await f.text(); if(!isUnifiedTsv(text)){ alert('çµ±åˆTSVã®å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆid, p, p, å•é¡Œæ–‡ï¼id, order, side, acc, amtï¼‰'); e.target.value=''; return; } const parsed=parseUnifiedTsv(text); if(parsed&&parsed.length){ PROBLEMS=parsed; rebuildSelect(); load(0); } else { alert('TSVã®å†…å®¹ã‚’è§£é‡ˆã§ãã¾ã›ã‚“ã§ã—ãŸ'); } e.target.value=''; };

  // ãƒ†ãƒ³ãƒ—ãƒ¬DLï¼ˆçµ±åˆ1æšï¼‰
  $btnTpl.onclick=()=>{ const blob=new Blob(['\uFEFF'+unifiedTsvTemplate()],{type:'text/tab-separated-values;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='problems_unified_template.tsv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1200); };
}

function init(){
  $sel=document.getElementById('problemSelect');
  $line=document.getElementById('problemLine');
  $ledger=document.getElementById('ledger');
  $learn=document.getElementById('learnPanel');
  $ledgerFb=document.getElementById('ledgerFeedback');
  $journalPanel=document.getElementById('journalPanel');
  $journalFb=document.getElementById('journalFeedback');
  $scoreAll=document.getElementById('scoreAll');
  $btnLoadCsv=document.getElementById('btnLoadCsv');
  $btnTpl=document.getElementById('btnTpl');
  $csvFile=document.getElementById('csvFile');
  $aiPrompt=document.getElementById('aiPrompt');
  if([$sel,$line,$ledger,$learn,$ledgerFb,$journalPanel,$journalFb,$scoreAll,$btnLoadCsv,$btnTpl,$csvFile,$aiPrompt].some(n=>!n)){ console.error('DOMè¦ç´ ä¸è¶³'); return; }

  // åŒä¸€ãƒ•ã‚©ãƒ«ãƒ€ã® problems_unified.tsv ã‚’è©¦ã—èª­ã¿ï¼ˆå¤±æ•—ã—ãŸã‚‰æ—¢å®šãƒ‡ãƒ¼ã‚¿ï¼‰
  tryFetchText('problems_unified.tsv')
    .then(txt=>{ if(isUnifiedTsv(txt)){ const parsed=parseUnifiedTsv(txt); if(parsed&&parsed.length){ PROBLEMS=parsed; rebuildSelect(); } } })
    .catch(()=>{ /* æ—¢å®šãƒ‡ãƒ¼ã‚¿ã®ã¾ã¾ */ })
    .finally(()=>{ setupUI(); load(0); });
}

if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',init); else init();

/********** çµ±åˆTSV é–¢é€£ **********/
async function tryFetchText(path){ const res=await fetch(path,{cache:'no-store'}); if(!res.ok) throw new Error('not ok'); return await res.text(); }

function tsvToRows(text){
  if(!text) return [];
  text = text.replace(/^\uFEFF/, '');
  const lines = text.replace(/\r\n?/g, '\n').split('\n').filter(s=>s.trim().length>0);
  return lines.map(line => line.split('\t'));
}

function isUnifiedTsv(text){
  const rows = tsvToRows(text);
  if(!rows.length) return false;
  return rows.some(r => (r[1]||'').trim().toLowerCase()==='p') ||
         rows.some(r => /^\d+$/.test((r[1]||'').trim()) && /^(d|c|å€Ÿ|è²¸)$/i.test((r[2]||'').trim()));
}

function parseUnifiedTsv(text){
  const rows = tsvToRows(text);
  const map = new Map(); // id -> {id,text,lines:[]}
  const normSide=(s)=>{ const t=(s||'').trim().toLowerCase(); if(t==='d'||t==='å€Ÿ') return 'D'; if(t==='c'||t==='è²¸') return 'C'; return ''; };

  for(const r of rows){
    const id=(r[0]||'').trim(); if(!id) continue;
    const tagOrOrder=(r[1]||'').trim();

    // å•é¡Œè¡Œ: id, p, p, text
    if(tagOrOrder.toLowerCase()==='p'){
      const textCol=(r[3]||'').trim();
      if(!map.has(id)) map.set(id,{id,text:'',lines:[]});
      if(textCol && !map.get(id).text) map.get(id).text=textCol; // æœ€åˆã®1ä»¶ã‚’æ¡ç”¨
      continue;
    }

    // æ˜ç´°è¡Œ: id, order, side, acc, amt
    const order=Number(tagOrOrder);
    const side=normSide(r[2]);
    const acc=(r[3]||'').trim();
    const amt=Number(String(r[4]||'').replace(/[,ï¼Œ]/g,''));
    if(!order || !side || !acc || !amt) continue;
    if(!map.has(id)) map.set(id,{id,text:'',lines:[]});
    map.get(id).lines.push({order,side,acc,amt});
  }

  const out=[];
  for(const v of map.values()){
    v.lines.sort((a,b)=> (a.order||0)-(b.order||0));
    if(v.id && v.text && v.lines.length){ out.push({ id:v.id, text:v.text, lines: v.lines.map(({side,acc,amt})=>({side,acc,amt})) }); }
  }
  return out;
}

function unifiedTsvTemplate(){
  return [
    'J2-1001\tp\tp\tä»•å…¥1,000å††ã‚’å½“åº§é é‡‘300å††æ”¯æ‰•ã„ã€æ®‹ã‚Šã¯è²·æ›é‡‘ã¨ã—ãŸã€‚',
    'J2-1001\t1\td\tä»•å…¥\t1000',
    'J2-1001\t2\tc\tå½“åº§é é‡‘\t300',
    'J2-1001\t3\tc\tè²·æ›é‡‘\t700',
    '',
    'J2-1002\tp\tp\tå£²æ›é‡‘500å††ã‚’ç¾é‡‘ã§å›åã—ãŸã€‚',
    'J2-1002\t1\td\tç¾é‡‘\t500',
    'J2-1002\t2\tc\tå£²æ›é‡‘\t500'
  ].join('\n');
}
</script>
</body>
</html>
