<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>仕訳→総勘定元帳（T勘定）転記学習ツール v2.8</title>
<style>
  :root{ --bg:#fff; --fg:#111827; --muted:#64748b; --line:#e5e7eb; --accent:#2563eb; --warn:#d97706; }
  body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
  .container{max-width:980px;margin:0 auto;padding:24px}
  .panel{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--line);padding:6px;text-align:center}
  th{background:#f1f5f9;font-size:12px}
  td{background:#fff}
  input{background:#fff;border:1px solid var(--line);padding:6px;border-radius:6px;font-size:14px;color:var(--fg);width:100%}
  input:focus{outline:2px solid var(--accent)}
  button{cursor:pointer;padding:6px 10px;border-radius:6px;border:1px solid var(--line);background:#fff;font-size:13px}
  .btn{background:var(--accent);border:none;color:#fff}
  .btn-warn{background:var(--warn);border:none;color:#fff}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#fff}

  /* T勘定 */
  .tcard{position:relative;background:#fff;border:1px solid var(--line);border-radius:14px;margin:14px 0;overflow:hidden}
  .tcard .theader{position:relative;height:34px;margin:0 8px}
  .tcard .theader::after{content:"";position:absolute;left:0;right:0;bottom:0;height:3px;background:#111827}
  .tcard .label{position:absolute;left:50%;top:0;transform:translateX(-50%);background:#fff;padding:0 10px;font-weight:800}
  .tcard::before{content:"";position:absolute;left:50%;top:34px;bottom:8px;width:3px;background:#111827;transform:translateX(-50%)}
  .tbody{display:grid;grid-template-columns:1fr 1fr;gap:0;position:relative;padding:8px}
  .tcol{padding:6px}
  .entry{display:flex;justify-content:space-between;gap:8px;border:1px solid #e5e7eb;background:#f8fafc;border-radius:8px;padding:6px}

  /* プロンプト */
  #prompt{width:100%;max-width:100%;min-height:120px;border:1px solid var(--line);border-radius:10px;padding:10px;white-space:pre-wrap;box-sizing:border-box;overflow-x:auto}
  *,*::before,*::after{box-sizing:border-box}
  input,button{min-width:0}
  .container{padding:16px}

  /* スマホでもPCと同じ左右レイアウトを維持 */
  @media (max-width: 640px){
    table{display:block;overflow-x:auto;width:100%}
    thead{display:table-header-group}
    tbody{display:table-row-group}
    tr{display:table-row}
    td,th{display:table-cell;white-space:nowrap}
  }
</style>
</head>
<body>
<div class="container">
  <h1>仕訳 → 総勘定元帳（T勘定）</h1>

  <!-- 仕訳入力 -->
  <section class="panel" id="journal">
    <div class="row">
      <label>日付 <input id="date" type="date"></label>
      <div class="right row">
        <button class="btn" id="add-row" type="button">行を追加</button>
        <button id="clear-rows" class="btn-warn" type="button">仕訳だけクリア</button>
        <button class="btn" id="post" type="button">この仕訳を転記</button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>借方科目</th>
          <th>借方金額</th>
          <th>貸方科目</th>
          <th>貸方金額</th>
          <th style="width:40px">操作</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <div class="row">
      <div class="pill">合計 借方：<span id="sumD">0</span> ／ 貸方：<span id="sumC">0</span>（<span id="balText" class="muted">不一致</span>）</div>
      <div class="right row">
        <button id="gen-prompt" type="button">解説プロンプト生成</button>
      </div>
    </div>
  </section>

  <!-- 元帳 -->
  <section class="panel" id="ledger" style="display:none">
    <div class="row">
      <h2 style="margin:0">総勘定元帳</h2>
      <div class="right row">
        <button class="btn-warn" id="reset-ledger" type="button">元帳リセット</button>
        <button class="btn-warn" id="reset-all" type="button">全リセット</button>
      </div>
    </div>
    <div id="tgrid" style="margin-top:8px"></div>
  </section>

  <!-- プロンプト表示 -->
  <section class="panel" id="prompt-panel">
    <div class="row" style="margin:0 0 8px;align-items:center">
      <h2 style="margin:0">解説プロンプト</h2>
      <div class="right"><button id="copy-prompt" class="btn" type="button">プロンプトをコピー</button></div>
    </div>
    <div id="prompt"></div>
  </section>
</div>

<script>
'use strict';
(function(){
  const SHOW_BREAKDOWN=false;
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const rowsTbody=$('#rows');
  const dateEl=$('#date');
  const sumD=$('#sumD'),sumC=$('#sumC'),balText=$('#balText');
  const ledgerPanel=$('#ledger');
  const tgrid=$('#tgrid');
  const promptBox=$('#prompt');
  const numJP=new Intl.NumberFormat('ja-JP');
  const hasFull=s=>/[０-９]/.test(s);
  const toMMDD=ds=>{if(!ds)return'';const d=new Date(ds+'T00:00:00');if(isNaN(d))return ds;return String(d.getMonth()+1).padStart(2,'0')+'/'+String(d.getDate()).padStart(2,'0');};
  const readAmt=el=>{const raw=(el.dataset.raw||el.value).replace(/,/g,'').trim();return /^\d+$/.test(raw)?Number(raw):0;};

  function addRow(){
    const tr=document.createElement('tr');
    tr.innerHTML='<td><input class="debit-acct" placeholder="例: 現金"></td>'+
      '<td><input type="text" class="debit-amt amt" inputmode="numeric" placeholder="0"></td>'+
      '<td><input class="credit-acct" placeholder="例: 売上"></td>'+
      '<td><input type="text" class="credit-amt amt" inputmode="numeric" placeholder="0"></td>'+
      '<td><button class="btn-warn del" type="button">✕</button></td>';
    rowsTbody.appendChild(tr);
  }
  function clearRows(){rowsTbody.innerHTML='';addRow();updateSums();}
  function iterLines(){const ls=[];$$('#rows tr').forEach(tr=>{const da=$('.debit-acct',tr).value.trim();const ca=$('.credit-acct',tr).value.trim();const d=readAmt($('.debit-amt',tr));const c=readAmt($('.credit-amt',tr));if((da&&d>0)||(ca&&c>0))ls.push({debitAccount:da,debit:d,creditAccount:ca,credit:c});});return ls;}
  function updateSums(){const ls=iterLines();const td=ls.reduce((s,l)=>s+l.debit,0);const tc=ls.reduce((s,l)=>s+l.credit,0);sumD.textContent=numJP.format(td);sumC.textContent=numJP.format(tc);balText.textContent=(td===tc&&td>0)?'一致':'不一致';return td===tc&&td>0;}

  rowsTbody.addEventListener('click',e=>{const btn=e.target.closest('.del');if(btn){btn.closest('tr')?.remove();updateSums();}});
  rowsTbody.addEventListener('focusin',e=>{if(e.target.matches('.amt')){const el=e.target;if(el.value)el.value=(el.dataset.raw||el.value).replace(/,/g,'');}});
  rowsTbody.addEventListener('blur',e=>{if(e.target.matches('.amt')){const el=e.target;if(hasFull(el.value)){alert('数字は半角で入力してください');el.value='';el.dataset.raw='';updateSums();return;}const raw=el.value.replace(/,/g,'').trim();if(raw===''){el.dataset.raw='';el.value='';updateSums();return;}if(!/^\d+$/.test(raw)){alert('数字のみを入力してください');el.value='';el.dataset.raw='';updateSums();return;}const n=Number(raw);el.dataset.raw=String(n);el.value=numJP.format(n);updateSums();}},true);
  rowsTbody.addEventListener('input',e=>{if(e.target.matches('.amt'))updateSums();});

  const ledger=new Map();
  const ensureAcc=n=>{if(!ledger.has(n))ledger.set(n,{debits:[],credits:[]});return ledger.get(n);};
  const hasLedger=()=>[...ledger.values()].some(v=>v.debits.length||v.credits.length);

  function entryNode(e){const wrap=document.createElement('div');const row=document.createElement('div');row.className='entry';row.innerHTML='<span class="muted">'+toMMDD(e.date)+'</span><span>'+e.cp+'</span><span>'+numJP.format(e.amount)+'</span>';wrap.appendChild(row);return wrap;}
  function renderLedger(){tgrid.innerHTML='';if(!hasLedger()){ledgerPanel.style.display='none';return;}ledgerPanel.style.display='block';const names=[...ledger.keys()].sort((a,b)=>a.localeCompare(b,'ja'));names.forEach(name=>{const acc=ledger.get(name);const card=document.createElement('div');card.className='tcard';card.innerHTML='<div class="theader"><div class="label">'+name+'</div></div><div class="tbody"><div class="tcol dcol"></div><div class="tcol ccol"></div></div>';const dcol=card.querySelector('.dcol'),ccol=card.querySelector('.ccol');acc.debits.forEach(e=>dcol.appendChild(entryNode(e)));acc.credits.forEach(e=>ccol.appendChild(entryNode(e)));tgrid.appendChild(card);});}

  function post(){if(!updateSums()){alert('貸借一致していません');return;}const date=dateEl.value;if(!date){alert('日付を入力してください');return;}const ls=iterLines();if(!ls.length){alert('仕訳がありません');return;}const deb=ls.filter(l=>l.debit>0&&l.debitAccount);const cre=ls.filter(l=>l.credit>0&&l.creditAccount);if(!deb.length||!cre.length){alert('借方と貸方を両方入力してください');return;}deb.forEach(d=>{const cps=[...new Set(cre.map(x=>x.creditAccount).filter(Boolean))];const cp=cps.length>1?'諸口':(cps[0]||'');ensureAcc(d.debitAccount).debits.push({date,cp,amount:d.debit});});cre.forEach(c=>{const cps=[...new Set(deb.map(x=>x.debitAccount).filter(Boolean))];const cp=cps.length>1?'諸口':(cps[0]||'');ensureAcc(c.creditAccount).credits.push({date,cp,amount:c.credit});});renderLedger();}

  function genPrompt(){const ls=iterLines();if(!ls.length){alert('仕訳がありません');return;}const d=dateEl.value?toMMDD(dateEl.value):'MM/DD';const lines=[];ls.forEach(l=>{if(l.debitAccount&&l.debit>0)lines.push('借方 '+l.debitAccount+' '+numJP.format(l.debit)+'円');if(l.creditAccount&&l.credit>0)lines.push('貸方 '+l.creditAccount+' '+numJP.format(l.credit)+'円');});const text='次の仕訳を総勘定元帳に転記する手順を、科目ごとに丁寧に説明してください。\n\n日付: '+d+'\n'+lines.join('\n')+'\n\n説明要件: 各科目ごとに、なぜ借方/貸方に記入するのか、相手科目が複数のとき「諸口」とする理由、よくある間違い例、確認問題を1問提示してください。';promptBox.textContent=text;}
  async function copyPrompt(){try{await navigator.clipboard.writeText(promptBox.textContent||'');alert('コピーしました');}catch{const ta=document.createElement('textarea');ta.value=promptBox.textContent||'';document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);alert('コピーしました');}}

  function resetLedger(){ ledger.clear(); renderLedger(); promptBox.textContent=''; }
  function resetAll(){ ledger.clear(); renderLedger(); clearRows(); promptBox.textContent=''; }

  function init(){try{dateEl.valueAsDate=new Date();}catch{}addRow();document.getElementById('add-row').addEventListener('click',addRow);document.getElementById('clear-rows').addEventListener('click',clearRows);document.getElementById('post').addEventListener('click',post);document.getElementById('gen-prompt').addEventListener('click',genPrompt);document.getElementById('copy-prompt').addEventListener('click',copyPrompt);document.getElementById('reset-ledger').addEventListener('click',resetLedger);document.getElementById('reset-all').addEventListener('click',resetAll);}

  init();
})();
</script>
</body>
</html>
